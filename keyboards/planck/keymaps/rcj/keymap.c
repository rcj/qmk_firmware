#include QMK_KEYBOARD_H

#include "action_layer.h"

#define MOD_SHIFT_MASK  (MOD_BIT(KC_LSFT)|MOD_BIT(KC_RSFT))
#define MOD_CTRL_MASK   (MOD_BIT(KC_LCTL)|MOD_BIT(KC_RCTRL))
#define MOD_ALT_MASK    (MOD_BIT(KC_LALT)|MOD_BIT(KC_RALT))

#define KC_DQOT LCAG(KC_Q)
#define KC_DBRK LCAG(KC_R)
#define KC_DBRC LCAG(KC_F)
#define KC_DCRL LCAG(KC_C)
#define KC_ANGL LCAG(KC_M)
#define KC_SBUF LCAG(KC_B)
#define KC_PREF LCAG(KC_U)
#define KC_SWIN LCAG(KC_N)

enum rcj_layers {
  _QWERTY,
  _SYMBOLS,
  _NUMPAD,
  _BRACES,
  _FN_KEYS,
  _ADJUST
};

enum rcj_keycodes {
  QWERTY = SAFE_RANGE,
  SYM_CBR,
  SYM_PRN,
  SYM_BRC
};

#define LEADER LCTL(KC_T)
#define SLCTL_T(kc) MT((MOD_LCTL | MOD_LGUI), kc)
#define SLALT_T(kc) MT((MOD_LCTL | MOD_LALT), kc)

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
/* Qwerty
 * ,-----------------------------------------------------------------------------------------------------.
 * |             |   Q  |  W  |   E   |  R   |   T   |   Y   |   U   |   I   |  O  |    P     | FN_KEYS  |
 * |-------------+------+-----+-------+------+---------------+-------+-------+-----+----------+----------|
 * | Sup+Alt/ENT |   A  |  S  |   D   |  F   |   G   |   H   |   J   |   K   |  L  |   Sym    | '        |
 * |-------------+------+-----+-------+------+-------+-------+-------+-------+-----+----------+----------|
 * | Sup+Ctrl/DEL|   Z  |  X  |   C   |  V   |   B   |   N   |   M   |   ,   |  .  |BRCES/SLSH| HYPER    |
 * |-------------+------+-----+-------+------+-------+-------+-------+-------+-----+----------+----------|
 * |   Esc       |      |     | NPAD  | Ctrl |   Shift/SPC   |  Alt  |  GUI  |     |  ADJUST  | Esc      |
 * `-----------------------------------------------------------------------------------------------------'
 */
[_QWERTY] = {
  {KC_TAB,          KC_Q,    KC_W,    KC_E,        KC_R,    KC_T,          KC_Y,          KC_U,           KC_I,    KC_O,    KC_P,                 KC_RALT},
  {SLALT_T(KC_ENT), KC_A,    KC_S,    KC_D,        KC_F,    KC_G,          KC_H,          KC_J,           KC_K,    KC_L,    MO(_SYMBOLS),         KC_QUOT},
  {SLCTL_T(KC_DEL), KC_Z,    KC_X,    KC_C,        KC_V,    KC_B,          KC_N,          KC_M,           KC_COMM, KC_DOT,  LT(_BRACES, KC_SLSH), KC_HYPR},
  {KC_ESC,          _______, _______, MO(_NUMPAD), KC_LCTL, SFT_T(KC_SPC), SFT_T(KC_SPC), KC_LALT,        KC_LGUI, _______, MO(_ADJUST),          KC_ESC}
},

/* Symbol-Map
 * ,-----------------------------------------------------------------------------.
 * |      |  `  |  \  |  =  |  *   |  ~  |  %  | S_U |  TAB | BSPC |      |      |
 * |------+-----+-----+-----+------+-----+-----+-----+------+------+------+------|
 * |      |  -  |  _  |  :  |   |  |  >  |  &  |  ;  |   !  |  <   |      |      |
 * |------+-----+-----+-----+------+-----+-----+-----+------+------+------+------|
 * |      |  +  |  @  |  '  | ENT  | S_B | S_N |  #  |   $  |  ^   |      |      |
 * |------+-----+-----+-----+------+-----+-----+-----+------+------+------+------|
 * |      |     |     |     |      |           |     |      |      |      |      |
 * `-----------------------------------------------------------------------------'
 */
[_SYMBOLS] = {
  {KC_PERC, KC_DQOT, KC_BSLS, KC_EQL,  KC_DBRK, KC_TILD,    KC_PIPE,    KC_PREF,    KC_TAB,  KC_BSPC, _______, _______},
  {KC_ASTR, KC_MINS, KC_UNDS, KC_COLN, KC_DBRC, KC_GT,      KC_AMPR,    KC_SCLN,    KC_EXLM, KC_LT,   _______, _______},
  {KC_ANGL, KC_PLUS, KC_AT,   KC_DCRL, KC_ENT,  KC_SBUF,    KC_SWIN,    KC_HASH,    KC_CIRC, KC_DLR,  _______, _______},
  {KC_GRV , _______, _______, _______, _______, _______,    _______,    _______,    _______, _______, _______, _______}
},

/* Numpad
 * ,------------------------------------------------------------------------------------.
 * |      | PSCR | PGUP |  UP  | PGDN  |      |      |   7  |   8  |   9  |      |      |
 * |------+------+------+------+-------+-------------+------+------+------+------+------|
 * |      | HOME | LEFT | DOWN | RIGHT | END  |   .  |   4  |   5  |   6  |   0  |      |
 * |------+------+------+------+-------+------+------+------+------+------+------+------|
 * |      | ENT  | INS  | TAB  |  SPC  |      |   ,  |   1  |   2  |   3  |      |      |
 * |------+------+------+------+-------+------+------+------+------+------+------+------|
 * |      |      |      |      |       |             |      |      |      |      |      |
 * `------------------------------------------------------------------------------------'
 */
[_NUMPAD] = {
  {_______, KC_PSCR, KC_PGUP, KC_UP,   KC_PGDN, _______, KC_0,    KC_7,    KC_8,    KC_9,    _______, _______},
  {_______, KC_HOME, KC_LEFT, KC_DOWN, KC_RGHT, KC_END,  KC_DOT,  KC_4,    KC_5,    KC_6,    _______,    _______},
  {_______, KC_ENT,  KC_INS,  KC_TAB,  KC_SPC,  _______, KC_COMM, KC_1,    KC_2,    KC_3,    _______, _______},
  {_______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______}
},

/* Braces
 * ,-----------------------------------------------------------------------.
 * |     |     |  {} |  {  |  }  |     | STOP|VDOWN| VUP |     |     |     |
 * |-----+-----+-----+-----+-----------+-----+-----+-----+-----+-----+-----|
 * |     |     |  () |  (  |  )  |     | LEFT| DOWN| UP  |RIGHT|     |     |
 * |-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----|
 * |     |     |  [] |  [  |  ]  |     | PLAY| PREV| NEXT|     |     |     |
 * |-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----|
 * |     |     |     |     |     |           |     |     |     |     |     |
 * `-----------------------------------------------------------------------'
 */
[_BRACES] = {
  {_______, _______, SYM_CBR, KC_LCBR, KC_RCBR, _______, KC_MSTP, KC_VOLD, KC_VOLU, _______, _______, _______},
  {_______, _______, SYM_PRN, KC_LPRN, KC_RPRN, _______, KC_LEFT, KC_DOWN, KC_UP,   KC_RGHT, _______, _______},
  {_______, _______, SYM_BRC, KC_LBRC, KC_RBRC, _______, KC_MPLY, KC_MRWD, KC_MFFD, _______, _______, _______},
  {_______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______}
},

/* FN_KEYS
 * ,-----------------------------------------------------------------------------------.
 * |      |  F1  |  F2  |  F3  |  F4  |      |      |      |      |      |      |      |
 * |------+------+------+------+------+-------------+------+------+------+------+------|
 * |      |  F5  |  F6  |  F7  |  F8  |      |      |      |      |      |      |      |
 * |------+------+------+------+------+------+------+------+------+------+------+------|
 * |      |  F9  |  F10 |  F11 |  F12 |      |      |      |      |      |      |      |
 * |------+------+------+------+------+------+------+------+------+------+------+------|
 * |      |      |      |      |      |             |      |      |      |      |      |
 * `-----------------------------------------------------------------------------------'
 */
[_FN_KEYS] = {
  {_______, KC_F1,   KC_F2,   KC_F3,   KC_F4,   _______, _______, _______, _______, _______, _______, _______},
  {_______, KC_F5,   KC_F6,   KC_F7,   KC_F8,   _______, _______, _______, _______, _______, _______, _______},
  {_______, KC_F9,   KC_F10,  KC_F11,  KC_F12,  _______, _______, _______, _______, _______, _______, _______},
  {_______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______}
},

/* Adjust
 * ,-----------------------------------------------------------------------------------.
 * |      | Reset| Debug|      |      |      |      |      |      |      |      |      |
 * |------+------+------+------+------+-------------+------+------+------+------+------|
 * |      |Qwerty|      |Aud on|Audoff|AGnorm|AGswap|      |      |      |      |      |
 * |------+------+------+------+------+------|------+------+------+------+------+------|
 * |      |Voice-|Voice+|Mus on|Musoff|MIDIon|MIDIof|      |      |      |      |      |
 * |------+------+------+------+------+------+------+------+------+------+------+------|
 * |      |      |      |      |      |             |      |      |      |      |      |
 * `-----------------------------------------------------------------------------------'
 */
[_ADJUST] = {
  {_______, QK_BOOT,   DB_TOGG,   _______, _______, _______, _______, _______, _______,_______, _______, _______},
  {_______, QWERTY,  _______, AU_ON,   AU_OFF,  AG_NORM, AG_SWAP, QWERTY,  _______, _______, _______, _______},
  {_______, AU_PREV,  AU_NEXT,  MU_ON,   MU_OFF,  MI_ON,   MI_OFF,  _______, _______, _______, _______, _______},
  {_______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______}
}


};

bool shifted = false;

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {
        case QWERTY:
            if (record->event.pressed) {
                set_single_persistent_default_layer(_QWERTY);
            }
            return false;
        case SYM_CBR:
        case SYM_PRN:
        case SYM_BRC:
        {
            char const* str =  keycode == SYM_BRC ? "{}" :
                              (keycode == SYM_PRN ? "()" : "[]");
            if (record->event.pressed) {
                shifted = get_mods() & MOD_SHIFT_MASK;
                if (shifted) {
                    // Otherwise [] becomes {}
                    unregister_mods(MOD_SHIFT_MASK);
                }
                send_string(str);
                if (shifted) {
                    SEND_STRING(SS_TAP(X_LEFT));
                }
            } else {
                if (shifted) {
                    register_mods(MOD_BIT(KC_LSFT));
                }
            }
            return false;
        }
    }
    return true;
}
